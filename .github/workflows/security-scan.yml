name: Aegis - Security Scan

on:
  # Run periodically to catch newly disclosed CVEs even when code didnâ€™t change.
  schedule:
    # Mondays 05:30 UTC (06:30 Europe/Berlin in winter).
    - cron: "30 5 * * 1"

  # Run on PRs only when file changes could affect the container contents.
  pull_request:
    branches: ["main"]
    paths:
    - ".github/workflows/security-scan.yml"
    - "**/Dockerfile*"
    - "**/*.csproj"
    - "**/*.slnx"
    - "**/requirements*.txt"
    - "**/requirements*.in"
    - "**/docker-compose*.yml"
    - "**/.dockerignore"

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  trivy-gateway-image-scan:
    name: Trivy Gateway Image Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build Gateway image
        working-directory: services/gateway
        run: docker build -t aegis-gateway:ci -f Dockerfile .

      - name: Trivy scan gateway image
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: "image"
          image-ref: "aegis-gateway:ci"
          format: "table"
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
          exit-code: "1"

  trivy-inspection-image-scan:
    name: Trivy inspection Image Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build Inspection Service image
        working-directory: services/inspection
        run: docker build -t aegis-inspection:ci -f Dockerfile .

      - name: Trivy scan Inspection image
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: "image"
          image-ref: "aegis-inspection:ci"
          format: "table"
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
          exit-code: "1"
          
  sbom-syft:
    name: SBOM (Syft)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0
        with:
          path: .
          format: spdx-json
          output-file: sbom-spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: sbom-spdx
          path: sbom-spdx.json
          retention-days: 7